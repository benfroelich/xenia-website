{% extends "base.html" %}
{% load wagtailcore_tags %}
{% load wagtailuserbar %}
{% block title %}{{ page.title }}{% endblock %}
{% block content %}
{% wagtailuserbar %}
<a href="{% pageurl page.get_parent %}" class="link-dark">Back to index</a>
{% if page %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
    <h1>{{ page.title }}</h1>
      {% if page.should_display_updated == True %}
        <p>updated {{ page.last_published_at|date:"SHORT_DATE_FORMAT" }}</p>
      {% endif %}
        <p>published {{ page.first_published_at|date:"SHORT_DATE_FORMAT" }}</p>
{% include_block page.body %}
{% else %}
      <p>No page dag yo</p>
{% endif %}
  <h2>Comments</h2>
  <div class="container border-top py-3">
  {% if not user.is_authenticated %}
  <a href="{% url 'register' %}" class="link-dark">Register</a> or <a href="{% url 'login' %}" class="link-dark">Log in</a> to comment
  {% endif %}
    <!-- create a new comment thread -->
    {% include 'cmsblog/comment_response.html' with form_id="new_comment" post_id=page.id thread_id="new" form_class="collapse show" mode="comment" %}
    {% for t in page.thread_set.all %}
      {% if t.comment_set.count > 0 %}
        <div class="my-3 p-3 border-start">
          {% for c in t.comment_set.all %}
            <!-- each comment -->
            {% include 'cmsblog/comment_response.html' with form_id=c.form_target post_id=page.id thread_id=t.pk form_class="collapse" mode="comment" comment=c %}
          {% endfor %}
          <!-- reply to this thread -->
          {% include 'cmsblog/comment_response.html' with form_id="new-comment-thread" post_id=page.id thread_id=t.pk form_class="collapse" mode="reply" %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>
  </div>

  <!-- modal for deletion confirmation -->
  <div class="modal fade" id="delete_modal" tabindex="-1">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" 
            data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Confirm Comment Deletion</p>
        </div>
        <div class="modal-footer">
          <form action="{% url 'blog:comment' 0 0 %}" 
            method="post" id="{{ form_id }}">
            {% csrf_token %}
            <input type="hidden" id="comment_id" name="comment_id" value="unset">
            <input type="hidden" id="thread_id" name="thread_id" value="unset">
            <input type="hidden" id="post_id" name="post_id" value="unset">
            <input type="hidden" name="_method" value="delete">
            <button type="submit" id="delete_confirm" class="btn btn-primary">Delete</button>
          </form>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock content %}

{% block scripts %}
<script>

  const delete_modal = document.getElementById('delete_modal')
  delete_modal.addEventListener('show.bs.modal', event => {
    // Button that triggered the modal
    const button = event.relatedTarget
    // Extract info from data-bs-* attributes
    const recipient = button.getAttribute('data-bs-whatever')
    const modal_ = delete_modal.querySelector('.modal-body input')

    // add specific info to the delete form in the modal
    const comment_id = button.getAttribute('data-comment-id')
    const post_id = button.getAttribute('data-post-id')
    const thread_id = button.getAttribute('data-thread-id')
    delete_modal.querySelector('#comment_id').value = comment_id
    delete_modal.querySelector('#post_id').value = post_id
    delete_modal.querySelector('#thread_id').value = thread_id
  })

  /*
  $('#delete_modal').on('show.bs.modal', function (event) {
    // this is the button that triggered the modal
    // it contains the comment specifics that will
    // be required to actually delete the comment
    const button = $(event.relatedTarget) 
    const comment_id = button.data('commentId')
    const post_id = button.data('postId')
    const thread_id = button.data('threadId')
    console.log(button.data())

    // assign the variables to the delete button on the dialog
    $('#delete_confirm').off('click')
    $('#delete_confirm').click(function() {
        delete_comment(post_id, thread_id, comment_id)
      })
  })
  */
</script>
{% endblock scripts %}
